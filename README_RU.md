# Neuro-predictor
[Ссылка на английскую версию README](./README.md)
Основная модель делает следующее - по картинке фазовой диаграммы предсказывает четыре физических параметра гамильтониана, которые описывают эту диаграмму.

## Установка

**Версия Python 3.9.2**

1. создать папку с окружением в root `python3.9 -m venv .venv`
2. активировать окружение `source .venv/bin/activate`
3. выполнить `pip install -r requirements.txt`

**В дальнейшем делать всё через окружение**

## Запуск веб-приложения

В папке app лежит код приложения, основной эндпоинт - calculate-parameters на вход которому передается файл с картинкой, а на выход он отдает 4 параметра в виде float

Чтобы запустить приложение нужно:

1. В папке app выполнить `uvicorn main:app --host 127.0.0.1 --port 8080`
1.1. возможно, придётся доставить пакеты
2. Перейти по урлу http://127.0.0.1:8080
3. После открытия фронта в дропдаун можно опустить любую картинку из папки ./tests/tests_files, фронт отправит запрос на бэк и он отдаст параметры. На процессоре предсказание происходит долго, поэтому возможно нужно будет подождать 5-10 секунд
4. Для работы через консоль выполнить `python3 console_predictor.py <path_to_jpg>`

## Генерация фазовых диаграмм
Файл image_generation.py генерирует изображения из исходных csv-файлов.  
Файл DataProcessor.py проходит по всем csv-файлам и с помощью image_generation.py генерирует изображения.  
Файл script_labels.py создает csv-файл с разметкой для обучения.  

## Модели машинного обучения

### UNET
В папке UNET находятся следующие файлы:
1) processing_data - подготовка изображений (сжатие с ~500х500 пикселей до 224х224), создание csv-файла с разметкой, разделение этого файла на 3 (train, val, test). Есть 2 версии - для MFA и cluster1.
2) UNET_FULL_2 - вспомогательная модель UNET (с энкодером и декодером), сильно переобучена, работает как автоэнкодер. По итогу обучения генерирует сохранившиеся веса энкодера в файл encoder_weights.npy;
3) UNET_WE_5 - собственно, сама модель. Опционально, в конце можно заморозить энкодер, чтобы он сохранил веса модели FULL;
4) dataset creation - Пересоздание датасета из папки, в которой лежат исходные csv файлы и в которой есть директория result с сгенерированными изображениями в папку output_dataset_directory откуда при обучении и тестировании буду браться файлы;
5) dataset_common_functions - вспомогательный скрипт для работы dataset_creation;
6) test_model - собственно, сами метрики модели;

Порядок запуска: 1, 2, 3, 4, 6.

Для удобства всё вынесено в config.json:
- "resize_images": true/false - необходимо ли сжимать изображения;
- "input_dir" - путь до папки с исходными несжатыми изображениями (игнорируется, если resize_images = false);
- "output_dir" - путь до папки с подготовленными изображениями;
- "learning_dir" - путь до папки с тренировочными данными.

**Запуск обучения UNET:**
```
./learn_UNET_mfa.sh config.json
```
для данных MFA или 
```
./learn_UNET_cluster1.sh config.json
```
для данных heat bath (они отличаются только порядком параметров в названии файлов *todo: сделать более универсальную версию*)

### VGG16 BN  
В папке VGG16BN находятся следующие файлы:  
1. processing_data.py - подготовка изображений (сжатие с ~500х500 пикселей до 224х224), создание csv-файла с разметкой, разделение этого файла на 3 (train, val, test)
2. dataset.py - предподготовка датасета
3. VGG16BN.py - сама модель
4. train_model.py - обучение модели; после завершения обучения получаем график лоссов при обучении и валидации
5. test_model.py - теститрование модели; после завершения тестирования сохраняет csv-файл с предсказаниями
6. stats.py - расчет относительной ошибки определения; статистическая обработка результатов (min, max, mean) с выводом в консоль; создает csv-файл со следующими колонками:
   * истинные значения параметров (D, V, tb, tp)
   * предсказанные значения параметров (Dpr, Vpr, tbpr, tppr)
   * рассчитанные значения MAPE (MAPE_D, MAPE_V, MAPE_tb, MAPE_tp)

Запускать файлы в порядке: 1, 4, 5, 6

## MFA
В папке mfa_scripts находятся следующие файлы:
1) phase_diagrammer.wls - скрипт WM, принимает в себя параметры гамильтониана D, V, J, tb, tp, tn, tpn, и выдаёт фазовую диаграмму.
Пример запуска:
```
phase_diagrammer.wls 0.12 0.28 1 0.5 0.4 0.4 0.05
```
2) task_parser.py - обрабатывает файл задач sample_params.json
3) run_calculations.sh - запуск расчётов через json-файл:
```
run_calculations.sh sample_params.json
```

##Heat bath
[Ссылка](https://drive.google.com/file/d/17eCNfKXNzxqwaY9UYharl6LsZmYsN6A3/view?usp=drive_link) на архив csv-файлов расчётных данных на гугл диске
[Ссылка](https://drive.google.com/drive/folders/1DrVuy_JWwjr5hKHdfcl8E4CCwVDHwBVq?usp=drive_link) на датасет картинок фазовых диаграмм



